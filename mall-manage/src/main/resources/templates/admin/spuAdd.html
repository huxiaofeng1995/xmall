<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:include="include/admin/adminHeader::html('小红商城')" ></head>
<body>
<script>
    $(function(){
        var data4Vue = {
            bean: {},
            flbh1: '',
            flbh2: '',
            pp_id: '',
            files: [],
            fileItems:[{index: 0,src: 'image/upload_hover.png'}]
        };
        //ViewModel
        var vue = new Vue({
            el: '#app',
            data: data4Vue,
            mounted:function(){ //mounted　表示这个 Vue 对象加载成功了
                this.bean.flbh1 = [[${spu.flbh1}]];
                this.bean.flbh2 = [[${spu.flbh2}]];
                this.bean.pp_id = [[${spu.pp_id}]];
                console.log(this.bean);
            },
            methods:{
                getFile: function (event,index) {
                    //this.files.push (event.target.files[0]);//多文件上传
                    this.files[index] = event.target.files[0] ;
                },
                add: function() {
                    var url = "spu";
                    var formData = new FormData();
                    formData.append("spu", JSON.stringify(vue.bean));
                    for(var i = 0; i < this.files.length;i++){//上传多个文件
                        formData.append("files", this.files[i]);
                    }
                    console.log(formData);
                    axios.post(url,formData).then(function(response) {
                        alert("添加成功");
                        location.reload();
                    });
                },
                upimg: function(index) {
                    console.log(vue.$refs);
                    //触发该img标签匹配的file input标签的点击事件，来上传文件
                    vue.$refs.imgFile[index].click();
                },
                upFile: function(event,index) {
                    //使用img标签预览上传的图片
                    //获得图片对象
                    var blob_img = event.target.files[0] ;
                    if(window.URL.createObjectURL) {
                        var url = window.URL.createObjectURL(blob_img);
                        //替换img,显示选中上传的图片
                        vue.fileItems[index].src = url;
                        //图片上传成功后，生成下一个空白的图片标签
                        this.addimg(index);
                    }else {
                        var fr = new FileReader();
                        fr.onload = function () {
                            vue.fileItems[index].src = this.result;
                        }
                        fr.readAsDataURL(blob_img);
                        this.addimg(index);
                    }
                    //将图片存入请求参数中
                    this.files[index] = blob_img;
                },
                addimg: function(index){
                    var length = vue.$refs.imgFile.length;//获取当前文件input/img 标签的数量
                    if((index+1) == length && index < 4){//说明用户点击的是最后一张,并限制图片个数,这里限制了5张图片
                        index++;
                        var obj= {index: index,src:'image/upload_hover.png'};
                        this.fileItems.push(obj)
                    }
                }
            }
        });
    });
</script>
<div id="app">
        spu信息添加[[${spu.flbh1}]]|[[${spu.flbh2}]]|[(${spu.pp_id})]
    	<hr>
        商品名称：<input name="shp_mch" type="text" v-model="bean.shp_mch"/><br>
        商品描述：<textarea name="shp_msh" rows="10" cols="50" v-model="bean.shp_msh"></textarea><br>
        商品图片：<br>
        <div id = "dimg" v-for="item in fileItems" style="float:left">
        	<input ref="imgFile" type="file" name="files" style="display: none" @change="upFile($event,item.index)"/>
        	<img :id="'img_'+item.index" style="cursor: pointer;margin-left: 5px" :src="item.src" width="100px" height='100px' @click="upimg(item.index)"/></div>
        <div style="clear:both"></div>
        <input type="submit" value="提交" @click="add"/>
</div>
</body>
</html>
